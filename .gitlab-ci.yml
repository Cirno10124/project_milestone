stages:
  - test
  - build

default:
  image: node:20
  cache:
    policy: pull-push
  before_script:
    - node --version
    - npm --version

workflow:
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_PIPELINE_SOURCE == "push"

# 通用：只在有变更/存在相应语言项目特征时才跑（避免影响纯 JS 仓库）
.rules_on_branch_or_mr: &rules_on_branch_or_mr
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH

# --------------------
# Frontend
# --------------------
frontend:test:
  stage: test
  cache:
    key: "frontend-${CI_COMMIT_REF_SLUG}"
    paths:
      - frontend/project_milestone_frontend/.npm/
  script:
    - cd frontend/project_milestone_frontend
    - npm ci --cache .npm --prefer-offline
    - npm run test:unit -- --run
  artifacts:
    when: always
    expire_in: 7 days
  <<: *rules_on_branch_or_mr

frontend:build:
  stage: build
  needs: ["frontend:test"]
  cache:
    key: "frontend-${CI_COMMIT_REF_SLUG}"
    paths:
      - frontend/project_milestone_frontend/.npm/
  script:
    - cd frontend/project_milestone_frontend
    - npm ci --cache .npm --prefer-offline
    - npm run build
  artifacts:
    expire_in: 7 days
    paths:
      - frontend/project_milestone_frontend/dist/
  <<: *rules_on_branch_or_mr

# --------------------
# Backend
# --------------------
backend:test:
  stage: test
  cache:
    key: "backend-${CI_COMMIT_REF_SLUG}"
    paths:
      - backend/.npm/
  script:
    - cd backend
    - npm ci --cache .npm --prefer-offline
    - npm test
  <<: *rules_on_branch_or_mr

backend:build:
  stage: build
  needs: ["backend:test"]
  cache:
    key: "backend-${CI_COMMIT_REF_SLUG}"
    paths:
      - backend/.npm/
  script:
    - cd backend
    - npm ci --cache .npm --prefer-offline
    - npm run build
  artifacts:
    expire_in: 7 days
    paths:
      - backend/dist/
  <<: *rules_on_branch_or_mr

# --------------------
# Python（可选）：仓库存在 pyproject/requirements 时自动启用
# --------------------
python:test:
  stage: test
  image: python:3.12
  cache:
    key: "python-${CI_COMMIT_REF_SLUG}"
    paths:
      - .pip-cache/
  script:
    - python --version
    - pip --version
    - python -m pip install -U pip
    # 依赖优先级：pyproject(Poetry/PDM/PEP517) 需要你们自行补充，这里先支持 requirements.txt
    - if [ -f requirements.txt ]; then pip install -r requirements.txt --cache-dir .pip-cache; fi
    - if [ -f requirements-dev.txt ]; then pip install -r requirements-dev.txt --cache-dir .pip-cache; fi
    - python -m compileall .
    - if [ -d tests ]; then python -m pytest -q; else echo "no tests/ dir, skip pytest"; fi
  rules:
    - exists:
        - "requirements.txt"
        - "requirements-dev.txt"
        - "pyproject.toml"

python:build:
  stage: build
  image: python:3.12
  needs: ["python:test"]
  cache:
    key: "python-${CI_COMMIT_REF_SLUG}"
    paths:
      - .pip-cache/
  script:
    - python --version
    - python -m pip install -U pip
    - if [ -f requirements.txt ]; then pip install -r requirements.txt --cache-dir .pip-cache; fi
    # 可选构建：如果你们是 wheel/sdist 项目，建议补上 python -m build
    - echo "python build placeholder (add packaging step if needed)"
  rules:
    - exists:
        - "requirements.txt"
        - "pyproject.toml"

# --------------------
# C++（可选）：仓库存在 CMakeLists/Makefile 时自动启用
# --------------------
cpp:build:
  stage: build
  image: gcc:14
  script:
    - gcc --version
    - g++ --version
    - apt-get update -y
    - apt-get install -y cmake ninja-build
    - |
      if [ -f CMakeLists.txt ]; then
        cmake -S . -B build -G Ninja -DCMAKE_BUILD_TYPE=Release
        cmake --build build
      elif [ -f Makefile ] || [ -f makefile ]; then
        make -j"$(nproc)"
      else
        echo "No CMakeLists.txt/Makefile, skip"
      fi
  artifacts:
    expire_in: 7 days
    paths:
      - build/
  rules:
    - exists:
        - "CMakeLists.txt"
        - "Makefile"
        - "makefile"


